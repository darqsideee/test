<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexTalk Web 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb, rgba(255,255,255,0.1)); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover, rgba(255,255,255,0.2)); }
        .story-ring-new { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .story-ring-seen { background: #3f3f46; } 
        @keyframes progress { from { width: 0%; } to { width: 100%; } }
        .animate-progress { animation: progress 5s linear forwards; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .typing-dot { animation: bounce 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        :root { --bg-primary: #0f0f13; --bg-secondary: #18181b; --bg-tertiary: #27272a; --text-primary: #ffffff; --text-secondary: rgba(255,255,255,0.6); --accent: #7A4DFF; --border: rgba(255,255,255,0.05); --msg-me: #7A4DFF; --msg-them: #27272a; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background 0.3s, color 0.3s; }
    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-[#7A4DFF] selection:text-white" id="app-body">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { MessageSquare, Users, Settings, Heart, Send, Plus, Image as ImageIcon, Search, LogOut, MoreVertical, Phone, X, Zap, Eye, Hash, Mail, AlertTriangle, CheckCircle, Camera, ChevronLeft, ChevronRight, Shield, User, Lock, Trash2, Ban, Globe, Volume2, UserPlus, Paperclip, MessageCircle, Activity, Skull, Radio, PauseCircle, PlayCircle, LogIn, UserX } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, deleteDoc, getDoc, where, arrayUnion, arrayRemove } from 'firebase/firestore';

        const firebaseConfig = { apiKey: "AIzaSyClqVa0abAGdbWre1SgNQ_LPE3OhFgwqC4", authDomain: "nextalk-4cb86.firebaseapp.com", projectId: "nextalk-4cb86", storageBucket: "nextalk-4cb86.firebasestorage.app", messagingSenderId: "894596255124", appId: "1:894596255124:web:6fdd8b80b8e96fc9aad381", measurementId: "G-M8EDS7KCE2" };
        const _appId = 'nextalk-production-v10';
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        const CLOUDFLARE_WORKER_URL = "https://nextalk-mailer.tvojedomena.workers.dev", ADMIN_EMAIL = "darqsideee@gmail.com";

        // Utils
        const generateCode = () => `${Array(3).fill(0).map(()=>"ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)]).join('')}-${Math.floor(100000+Math.random()*900000)}`;
        const getAvatar = (uid) => `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}&backgroundColor=b6e3f4`;
        const handleFile = (file) => new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => res(r.result); r.onerror = rej; });
        const formatTime = (ts) => {
            if (!ts) return "Nyní";
            const diff = Math.floor((new Date() - (ts.toMillis ? new Date(ts.toMillis()) : new Date(ts))) / 1000);
            return diff < 60 ? "právě teď" : diff < 3600 ? `před ${Math.floor(diff/60)} min` : diff < 86400 ? `před ${Math.floor(diff/3600)} hod` : new Date(ts.toMillis ? ts.toMillis() : ts).toLocaleDateString();
        };
        const logAction = (text) => addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'audit_log'), { text, createdAt: serverTimestamp() });
        const sendEmail = async (to, subject, title, message) => { if(CLOUDFLARE_WORKER_URL.includes("workers.dev")) try { await fetch(CLOUDFLARE_WORKER_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,title,message})}); } catch(e){console.error(e);} };

        // Components
        const ThemeInjector = ({ theme, c }) => {
            useEffect(() => {
                const s = document.documentElement.style;
                const def = { '--bg-primary': '#0f0f13', '--bg-secondary': '#18181b', '--bg-tertiary': '#27272a', '--text-primary': '#ffffff', '--text-secondary': 'rgba(255,255,255,0.6)', '--accent': '#7A4DFF', '--border': 'rgba(255,255,255,0.05)', '--msg-me': '#7A4DFF', '--msg-them': '#27272a' };
                const light = { '--bg-primary': '#f4f4f5', '--bg-secondary': '#ffffff', '--bg-tertiary': '#e4e4e7', '--text-primary': '#18181b', '--text-secondary': '#71717a', '--border': 'rgba(0,0,0,0.1)', '--msg-me': '#7A4DFF', '--msg-them': '#e4e4e7' };
                const custom = c ? { '--bg-primary': c.bgPrimary, '--bg-secondary': c.bgSecondary, '--bg-tertiary': c.bgSecondary+'80', '--text-primary': c.text, '--text-secondary': c.text+'99', '--accent': c.accent, '--border': c.text+'20', '--msg-me': c.accent, '--msg-them': c.bgSecondary+'90' } : {};
                const t = theme === 'light' ? light : (theme === 'custom' ? custom : def);
                Object.entries(t).forEach(([k,v]) => s.setProperty(k, v));
            }, [theme, c]);
            return null;
        };

        const Glass = ({ children, className="", onClick, onCtx }) => <div onClick={onClick} onContextMenu={onCtx} className={`backdrop-blur-xl bg-[var(--bg-secondary)] border border-[var(--border)] shadow-xl ${className}`}>{children}</div>;
        const Modal = ({ onClose, title, children }) => (
            <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 animate-in fade-in">
                <Glass className="w-full max-w-lg max-h-[85vh] flex flex-col rounded-2xl">
                    <div className="p-5 border-b border-[var(--border)] flex justify-between items-center"><h2 className="text-xl font-bold text-[var(--text-primary)]">{title}</h2><button onClick={onClose}><X size={20} className="text-[var(--text-primary)]"/></button></div>
                    <div className="p-6 overflow-y-auto custom-scrollbar text-[var(--text-primary)]">{children}</div>
                </Glass>
            </div>
        );
        const Button = ({ children, onClick, className="", variant="primary" }) => (
            <button onClick={onClick} className={`px-4 py-2 rounded-xl font-bold transition-all active:scale-95 ${variant==="primary"?"bg-[var(--accent)] text-white hover:brightness-110":variant==="danger"?"bg-red-500/20 text-red-500 hover:bg-red-500/30":"bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-opacity-80"} ${className}`}>{children}</button>
        );
        const Input = ({ type="text", placeholder, value, onChange, icon:Icon, className="" }) => (
            <div className="relative w-full">
                {Icon && <Icon className="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] w-5 h-5" />}
                <input type={type} placeholder={placeholder} value={value} onChange={onChange} className={`w-full bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-[var(--accent)] ${Icon?'pl-12':'pl-4'} ${className}`}/>
            </div>
        );

        // Screens
        const AuthScreen = () => {
            const [m, setM] = useState('login'), [e, setE] = useState(""), [p, setP] = useState(""), [u, setU] = useState(""), [err, setErr] = useState("");
            const handle = async (ev) => {
                ev.preventDefault(); setErr("");
                try {
                    if (m === 'register') {
                        if (u.length < 3) throw new Error("Jméno je krátké");
                        const c = await createUserWithEmailAndPassword(auth, e, p);
                        await sendEmailVerification(c.user);
                        await setDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', c.user.uid), { uid: c.user.uid, email: e, displayName: u, friendCode: generateCode(), avatarUrl: getAvatar(c.user.uid), friends: [], blocked: [], theme: 'dark', isAdmin: false });
                        setM('verify');
                    } else if (m === 'login') await signInWithEmailAndPassword(auth, e, p);
                } catch (Ex) { setErr(Ex.message.replace('Firebase: ','')); }
            };
            return (
                <div className="flex items-center justify-center min-h-screen bg-[#0a0a0c]">
                    <Glass className="w-full max-w-md p-8 rounded-2xl">
                        <h1 className="text-3xl font-black text-white text-center mb-8">NexTalk</h1>
                        {m === 'verify' ? <div className="text-center text-white space-y-4"><p>Ověř email (zkontroluj SPAM)</p><Button onClick={()=>window.location.reload()} className="w-full">Hotovo</Button></div> : 
                        <form onSubmit={handle} className="space-y-4">
                            {m === 'register' && <Input icon={User} placeholder="Jméno" value={u} onChange={x=>setU(x.target.value)}/>}
                            <Input icon={Mail} type="email" placeholder="Email" value={e} onChange={x=>setE(x.target.value)}/>
                            <Input icon={Lock} type="password" placeholder="Heslo" value={p} onChange={x=>setP(x.target.value)}/>
                            {err && <div className="p-2 bg-red-500/20 text-red-400 text-sm rounded text-center">{err}</div>}
                            <Button className="w-full">{m==='login'?'Přihlásit':'Registrovat'}</Button>
                            <div className="text-center"><button type="button" onClick={()=>setM(m==='login'?'register':'login')} className="text-sm text-white/50">{m==='login'?'Registrace':'Přihlášení'}</button></div>
                        </form>}
                    </Glass>
                </div>
            );
        };

        const SettingsModal = ({ user, onClose }) => {
            const [tab, setTab] = useState('appearance'), [code, setCode] = useState("");
            const saveTheme = (t) => updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { theme: t });
            const activate = async () => { if(code==="NEXTALK105"){ await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { isAdmin: true }); window.location.reload(); } else alert("Chyba"); };
            return (
                <Modal onClose={onClose} title="Nastavení">
                    <div className="flex gap-4 min-h-[400px]">
                        <div className="w-1/3 space-y-2 border-r border-[var(--border)] pr-2">
                            {['appearance','security'].map(t=><button key={t} onClick={()=>setTab(t)} className={`w-full text-left p-3 rounded-xl ${tab===t?'bg-[var(--accent)] text-white':'text-[var(--text-secondary)]'}`}>{t==='appearance'?'Vzhled':'Bezpečnost'}</button>)}
                        </div>
                        <div className="flex-1 space-y-4">
                            {tab==='appearance' && <div className="grid grid-cols-2 gap-2">{['dark','light'].map(t=><div key={t} onClick={()=>saveTheme(t)} className={`h-16 border-2 rounded-xl flex items-center justify-center cursor-pointer capitalize ${user.theme===t?'border-[var(--accent)]':'border-transparent'} ${t==='dark'?'bg-[#111] text-white':'bg-white text-black'}`}>{t}</div>)}</div>}
                            {tab==='security' && <div className="mt-8 border-t border-[var(--border)] pt-4"><h3 className="text-red-500 font-bold mb-2">ADMIN ZONE</h3><div className="flex gap-2"><Input type="password" placeholder="Kód" value={code} onChange={e=>setCode(e.target.value)}/><Button variant="danger" onClick={activate}>Aktivovat</Button></div></div>}
                        </div>
                    </div>
                </Modal>
            );
        };

        const AdminDash = ({ user, allUsers, onExit }) => {
            const [tab, setTab] = useState('overview'), [data, setData] = useState({crews:[], posts:[], stories:[], logs:[]}), [sysMsg, setSysMsg] = useState("");
            const [ghost, setGhost] = useState(null), [gCh, setGCh] = useState('general'), [gMsgs, setGMsgs] = useState([]);
            
            useEffect(() => {
                const u1=onSnapshot(collection(db,'artifacts',_appId,'public','data','crews'),s=>setData(p=>({...p,crews:s.docs.map(d=>({id:d.id,...d.data()}))})));
                const u2=onSnapshot(collection(db,'artifacts',_appId,'public','data','posts'),s=>setData(p=>({...p,posts:s.docs.map(d=>({id:d.id,...d.data()}))})));
                const u3=onSnapshot(collection(db,'artifacts',_appId,'public','data','stories'),s=>setData(p=>({...p,stories:s.docs.map(d=>({id:d.id,...d.data()}))})));
                const u4=onSnapshot(query(collection(db,'artifacts',_appId,'public','data','audit_log'),orderBy('createdAt','desc')),s=>setData(p=>({...p,logs:s.docs.map(d=>({id:d.id,...d.data()}))})));
                return ()=>{u1();u2();u3();u4();};
            }, []);
            useEffect(() => { if(ghost) return onSnapshot(query(collection(db,'artifacts',_appId,'public','data','crews',ghost.id,'channels',gCh,'messages'),orderBy('createdAt','asc')),s=>setGMsgs(s.docs.map(d=>({id:d.id,...d.data()})).filter(m=>!m.deleted))); }, [ghost, gCh]);

            const act = async (type, payload) => {
                if(type==='ban') { await updateDoc(doc(db,'artifacts',_appId,'public','data','users',payload),{banned:!allUsers[payload].banned}); logAction(`Ban/Unban ${payload}`); }
                if(type==='del') { await updateDoc(doc(db,'artifacts',_appId,'public','data',payload.col,payload.id),{deleted:true}); logAction(`Del ${payload.col} ${payload.id}`); }
                if(type==='sys') {
                    const base = {authorId:user.uid, authorName:"NexTalk (Official)", authorAvatar:"https://ui-avatars.com/api/?name=Nextalk&background=7A4DFF&color=fff", createdAt:serverTimestamp(), isSystem:true};
                    if(payload==='post') await addDoc(collection(db,'artifacts',_appId,'public','data','posts'),{...base, content:sysMsg, likes:[], comments:[]});
                    else await addDoc(collection(db,'artifacts',_appId,'public','data','stories'),{...base, imageUrl:`https://placehold.co/600x800/7A4DFF/ffffff?text=${encodeURIComponent(sysMsg)}`, viewers:[]});
                    setSysMsg(""); alert("Odesláno");
                }
                if(type==='freeze') await updateDoc(doc(db,'artifacts',_appId,'public','data','crews',payload.id),{frozen:!payload.frozen});
                if(type==='off') { await updateDoc(doc(db,'artifacts',_appId,'public','data','users',user.uid),{isAdmin:false}); onExit(); }
            };

            return (
                <div className="h-full flex flex-col bg-[#111]">
                    <div className="bg-red-900/20 p-4 flex justify-between items-center border-b border-red-500/30">
                        <h2 className="text-xl font-bold text-red-500 flex gap-2"><Shield/> ADMIN</h2>
                        <div className="flex gap-2">{['overview','users','crews','content'].map(t=><button key={t} onClick={()=>setTab(t)} className={`px-2 py-1 rounded text-xs uppercase font-bold ${tab===t?'bg-red-600 text-white':'bg-red-900/40 text-red-300'}`}>{t}</button>)}</div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4">
                        {tab==='overview' && <div className="space-y-4">
                            <div className="flex justify-between bg-[#1a1a1a] p-4 rounded border border-white/10"><h3>Ovládání</h3><Button variant="danger" onClick={()=>act('off')}>Vypnout Tools</Button></div>
                            <div className="bg-[#1a1a1a] p-4 rounded border border-white/10">
                                <h3 className="text-[var(--accent)] font-bold mb-2">NexTalk Oznámení</h3>
                                <div className="flex gap-2"><input value={sysMsg} onChange={e=>setSysMsg(e.target.value)} className="flex-1 bg-black/30 border border-white/10 rounded px-2 text-white"/><Button onClick={()=>act('sys','post')} className="text-xs">Post</Button><Button onClick={()=>act('sys','story')} variant="secondary" className="text-xs">Story</Button></div>
                            </div>
                        </div>}
                        {tab==='users' && Object.values(allUsers).map(u=><div key={u.uid} className="flex justify-between items-center bg-[#1a1a1a] p-2 rounded border border-white/10"><div className="flex gap-2 items-center"><img src={u.avatarUrl} className="w-6 h-6 rounded-full"/><span className="text-sm font-bold">{u.displayName}</span></div><Button variant={u.banned?"primary":"danger"} onClick={()=>act('ban',u.uid)} className="py-0 px-2 text-xs">{u.banned?"UNBAN":"BAN"}</Button></div>)}
                        {tab==='content' && [...data.posts, ...data.stories].filter(x=>!x.deleted).map(x=><div key={x.id} className="flex justify-between bg-[#1a1a1a] p-2 rounded border border-white/10 mb-2"><span className="text-xs truncate max-w-[80%]">{x.content||"(Story)"}</span><button onClick={()=>act('del',{col:x.content?'posts':'stories',id:x.id})}><Trash2 size={14} className="text-red-400"/></button></div>)}
                        {tab==='crews' && data.crews.map(c=><div key={c.id} className="flex justify-between items-center bg-[#1a1a1a] p-2 rounded border border-white/10 mb-2">
                            <span className={`text-sm font-bold ${c.frozen?'text-red-500':''}`}>{c.name} {c.frozen&&'(Locked)'}</span>
                            <div className="flex gap-1"><Button variant="secondary" onClick={()=>{setGhost(c);setGCh(c.channels[0])}} className="py-0 px-2"><Eye size={12}/></Button><Button variant="danger" onClick={()=>act('freeze',c)} className="py-0 px-2">{c.frozen?<PlayCircle size={12}/>:<PauseCircle size={12}/>}</Button><Button variant="danger" onClick={()=>act('del',{col:'crews',id:c.id})} className="py-0 px-2">X</Button></div>
                        </div>)}
                    </div>
                    {ghost && <Modal title={`Ghost: ${ghost.name}`} onClose={()=>setGhost(null)}>
                        <div className="flex h-64 gap-2">
                            <div className="w-24 border-r border-white/10">{ghost.channels.map(ch=><div key={ch} onClick={()=>setGCh(ch)} className={`text-xs p-1 cursor-pointer ${gCh===ch?'text-[var(--accent)]':'text-gray-400'}`}>#{ch}</div>)}</div>
                            <div className="flex-1 overflow-y-auto">{gMsgs.map(m=><div key={m.id} className="text-xs mb-1"><span className="font-bold text-[var(--accent)]">{allUsers[m.authorId]?.displayName}:</span> {m.text}</div>)}</div>
                        </div>
                    </Modal>}
                </div>
            );
        };

        const Crews = ({ user, allUsers }) => {
            const [crews, setCrews] = useState([]), [sel, setSel] = useState(null), [ch, setCh] = useState('general'), [msgs, setMsgs] = useState([]);
            const [modal, setModal] = useState(null), [name, setName] = useState(""), [code, setCode] = useState(""), [txt, setTxt] = useState("");

            useEffect(()=>onSnapshot(query(collection(db,'artifacts',_appId,'public','data','crews')),s=>setCrews(s.docs.map(d=>({id:d.id,...d.data()})).filter(c=>!c.deleted))),[]);
            useEffect(()=>{ if(sel) return onSnapshot(query(collection(db,'artifacts',_appId,'public','data','crews',sel.id,'channels',ch,'messages'),orderBy('createdAt','asc')),s=>setMsgs(s.docs.map(d=>({id:d.id,...d.data()})).filter(m=>!m.deleted))); },[sel,ch]);

            const create = async () => { await addDoc(collection(db,'artifacts',_appId,'public','data','crews'),{name, owner:user.uid, icon:`https://ui-avatars.com/api/?name=${name}`, members:[user.uid], channels:['general','voice'], frozen:false}); setModal(null); setName(""); };
            const join = async () => { try { const r=doc(db,'artifacts',_appId,'public','data','crews',code); const s=await getDoc(r); if(s.exists()&&!s.data().deleted&&!s.data().frozen){ await updateDoc(r,{members:arrayUnion(user.uid)}); setModal(null); setCode(""); alert("OK"); } else alert("Err"); } catch(e){alert("Err");} };
            const send = async () => { if(!txt.trim() || sel.frozen) return; await addDoc(collection(db,'artifacts',_appId,'public','data','crews',sel.id,'channels',ch,'messages'),{text:txt, authorId:user.uid, createdAt:serverTimestamp()}); setTxt(""); };

            return (
                <div className="h-full flex flex-col items-center p-4">
                    <div className="w-full max-w-4xl flex-1 flex flex-col">
                        <div className="flex justify-center gap-4 mb-4"><Button onClick={()=>setModal('create')}>Vytvořit</Button><Button variant="secondary" onClick={()=>setModal('join')}>Připojit</Button></div>
                        <div className="flex-1 overflow-y-auto space-y-2 custom-scrollbar pb-4">
                            {crews.filter(c=>c.members.includes(user.uid)).map(c=>(
                                <div key={c.id} className={`bg-[var(--bg-secondary)] border rounded-xl overflow-hidden ${c.frozen?'border-red-500/50':'border-[var(--border)]'}`}>
                                    <div className="p-3 flex items-center gap-3 cursor-pointer hover:bg-[var(--bg-tertiary)]" onClick={()=>setSel(sel?.id===c.id?null:c)}>
                                        <img src={c.icon} className="w-10 h-10 rounded-lg"/><div className="flex-1 font-bold">{c.name} {c.frozen&&<Lock size={14} className="inline text-red-500"/>}</div><span className="text-xs text-[var(--text-secondary)]">{c.members.length}</span>
                                    </div>
                                    {sel?.id===c.id && <div className="border-t border-[var(--border)] bg-[var(--bg-primary)] p-2">
                                        <div className="flex gap-2 mb-2 overflow-x-auto">{c.channels.map(x=><div key={x} onClick={()=>setCh(x)} className={`px-3 py-1 rounded-lg cursor-pointer text-sm ${ch===x?'bg-[var(--accent)] text-white':'bg-[var(--bg-secondary)]'}`}>#{x}</div>)}</div>
                                        <div className="h-64 bg-[var(--bg-secondary)] rounded-lg flex flex-col border border-[var(--border)]">
                                            {c.frozen ? <div className="m-auto text-red-500 font-bold flex flex-col items-center"><Lock/>ZAMČENO</div> : <>
                                                <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">{msgs.map(m=><div key={m.id} className={`text-sm break-words px-2 py-1 rounded-lg w-fit max-w-[80%] ${m.authorId===user.uid?'ml-auto bg-[var(--msg-me)] text-white':'bg-[var(--msg-them)] text-[var(--text-primary)]'}`}>{m.text}</div>)}</div>
                                                <div className="p-2 flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} className="flex-1 bg-[var(--bg-tertiary)] rounded px-2 outline-none text-[var(--text-primary)]" placeholder="Zpráva..."/><button onClick={send}><Send size={16} className="text-[var(--accent)]"/></button></div>
                                            </>}
                                        </div>
                                    </div>}
                                </div>
                            ))}
                        </div>
                    </div>
                    {modal==='create' && <Modal title="Nová Crew" onClose={()=>setModal(null)}><Input placeholder="Název" value={name} onChange={e=>setName(e.target.value)}/><Button onClick={create} className="w-full mt-4">Vytvořit</Button></Modal>}
                    {modal==='join' && <Modal title="Připojit se" onClose={()=>setModal(null)}><Input placeholder="ID Crew" value={code} onChange={e=>setCode(e.target.value)}/><Button onClick={join} className="w-full mt-4">Připojit</Button></Modal>}
                </div>
            );
        };

        const Friends = ({ user, allUsers }) => {
            const [code, setCode] = useState(""), [add, setAdd] = useState(false), [chat, setChat] = useState(null), [reqs, setReqs] = useState([]), [msgs, setMsgs] = useState([]), [txt, setTxt] = useState(""), [prof, setProf] = useState(null);
            const friends = user.friends?.map(u=>({uid:u,...allUsers[u]})).filter(u=>u.displayName)||[];

            useEffect(()=>onSnapshot(query(collection(db,'artifacts',_appId,'public','data','requests'),where('to','==',user.uid)),s=>setReqs(s.docs.map(d=>({id:d.id,...d.data()})))),[]);
            useEffect(()=>{ if(chat) return onSnapshot(query(collection(db,'artifacts',_appId,'public','data','messages'),orderBy('createdAt','asc')),s=>setMsgs(s.docs.map(d=>({id:d.id,...d.data()})).filter(m=>(m.from===user.uid&&m.to===chat.uid)||(m.from===chat.uid&&m.to===user.uid)))); },[chat]);

            const sendReq = async () => { const t = Object.values(allUsers).find(u=>u.friendCode===code); if(t && t.uid!==user.uid && !user.friends.includes(t.uid)) { await addDoc(collection(db,'artifacts',_appId,'public','data','requests'),{from:user.uid, to:t.uid, fromName:user.displayName, fromAvatar:user.avatarUrl}); setAdd(false); alert("Odesláno"); } else alert("Chyba"); };
            const accept = async (r) => { await updateDoc(doc(db,'artifacts',_appId,'public','data','users',user.uid),{friends:arrayUnion(r.from)}); await updateDoc(doc(db,'artifacts',_appId,'public','data','users',r.from),{friends:arrayUnion(user.uid)}); await deleteDoc(doc(db,'artifacts',_appId,'public','data','requests',r.id)); };
            const sendMsg = async () => { if(txt.trim()) await addDoc(collection(db,'artifacts',_appId,'public','data','messages'),{from:user.uid, to:chat.uid, text:txt, createdAt:serverTimestamp()}); setTxt(""); };
            const manage = async (act, uid) => { if(act==='rem'){ await updateDoc(doc(db,'artifacts',_appId,'public','data','users',user.uid),{friends:arrayRemove(uid)}); await updateDoc(doc(db,'artifacts',_appId,'public','data','users',uid),{friends:arrayRemove(user.uid)}); } if(act==='blk') await updateDoc(doc(db,'artifacts',_appId,'public','data','users',user.uid),{blocked:arrayUnion(uid)}); setProf(null); };

            if(chat) return (
                <div className="flex flex-col h-full">
                    <div className="h-14 border-b border-[var(--border)] flex items-center px-4 gap-3 bg-[var(--bg-secondary)]"><button onClick={()=>setChat(null)}><ChevronLeft/></button><img src={chat.avatarUrl} className="w-8 h-8 rounded-full"/><span className="font-bold">{chat.displayName}</span></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">{msgs.map(m=><div key={m.id} className={`flex flex-col ${m.from===user.uid?'items-end':'items-start'}`}><div className={`px-3 py-2 rounded-xl max-w-[75%] text-sm ${m.from===user.uid?'bg-[var(--msg-me)] text-white':'bg-[var(--msg-them)] text-[var(--text-primary)]'}`}>{m.text}</div><span className="text-[10px] opacity-50">{formatTime(m.createdAt)}</span></div>)}</div>
                    <div className="p-3"><div className="bg-[var(--bg-tertiary)] rounded-full flex p-1 border border-[var(--border)]"><input value={txt} onChange={e=>setTxt(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendMsg()} className="flex-1 bg-transparent px-3 outline-none" placeholder="Zpráva..."/><button onClick={sendMsg} className="p-2 rounded-full bg-[var(--msg-me)] text-white"><Send size={16}/></button></div></div>
                </div>
            );

            return (
                <div className="p-6 h-full overflow-y-auto">
                    <div className="flex justify-between mb-4"><h2 className="text-xl font-bold">Přátelé</h2><Button onClick={()=>setAdd(true)}><UserPlus size={16}/></Button></div>
                    {reqs.length>0 && <div className="mb-4 space-y-2">{reqs.map(r=><div key={r.id} className="bg-[var(--bg-secondary)] p-2 rounded border border-[var(--accent)] flex justify-between items-center"><div className="flex items-center gap-2"><img src={r.fromAvatar} className="w-6 h-6 rounded-full"/><span className="text-sm">Žádost: {r.fromName}</span></div><div className="flex gap-1"><Button onClick={()=>accept(r)} className="py-0 px-2 text-xs">OK</Button><button onClick={()=>deleteDoc(doc(db,'artifacts',_appId,'public','data','requests',r.id))}><X size={14} className="text-red-400"/></button></div></div>)}</div>}
                    <div className="space-y-2">{friends.map(f=><div key={f.uid} className="bg-[var(--bg-secondary)] p-3 rounded-xl border border-[var(--border)] flex items-center gap-3"><img src={f.avatarUrl} className="w-10 h-10 rounded-full"/><div className="flex-1 font-bold">{f.displayName}</div><div className="flex gap-2 text-[var(--text-secondary)]"><button onClick={()=>setChat(f)}><MessageCircle/></button><button onClick={()=>setProf(f)}><User/></button></div></div>)}</div>
                    {add && <Modal title="Přidat" onClose={()=>setAdd(false)}><div className="text-center font-mono text-[var(--accent)] text-lg mb-2">{user.friendCode}</div><Input placeholder="Kód (ABC-123456)" value={code} onChange={e=>setCode(e.target.value)}/><Button onClick={sendReq} className="w-full mt-4">Poslat</Button></Modal>}
                    {prof && <Modal title="Profil" onClose={()=>setProf(null)}><div className="text-center space-y-3"><img src={prof.avatarUrl} className="w-20 h-20 rounded-full mx-auto"/><h2 className="text-xl font-bold">{prof.displayName}</h2><div className="text-sm opacity-70">{prof.bio||"..."}</div><div className="flex gap-2 justify-center"><Button onClick={()=>{setChat(prof);setProf(null)}}>Chat</Button><Button variant="danger" onClick={()=>manage('rem',prof.uid)}><UserX size={16}/></Button><Button variant="danger" onClick={()=>manage('blk',prof.uid)}><Ban size={16}/></Button></div></div></Modal>}
                </div>
            );
        };

        const Feed = ({ user, allUsers }) => {
            const [posts, setPosts] = useState([]), [txt, setTxt] = useState("");
            useEffect(()=>onSnapshot(query(collection(db,'artifacts',_appId,'public','data','posts'),orderBy('createdAt','desc')),s=>setPosts(s.docs.map(d=>({id:d.id,...d.data()})).filter(p=>!p.deleted))),[]);
            const post = async () => { if(txt) await addDoc(collection(db,'artifacts',_appId,'public','data','posts'),{authorId:user.uid, authorName:user.displayName, authorAvatar:user.avatarUrl, content:txt, likes:[], comments:[], createdAt:serverTimestamp()}); setTxt(""); };
            return (
                <div className="h-full overflow-y-auto p-6 max-w-2xl mx-auto space-y-6 custom-scrollbar">
                    <Glass className="p-4 rounded-xl flex gap-3"><img src={user.avatarUrl} className="w-10 h-10 rounded-full"/><div className="flex-1"><textarea value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Co se děje?" className="w-full bg-transparent outline-none resize-none"/><div className="flex justify-end border-t border-[var(--border)] pt-2"><Button onClick={post} className="py-1 px-3 text-sm">Post</Button></div></div></Glass>
                    {posts.map(p=><Glass key={p.id} className={`rounded-xl overflow-hidden ${p.isSystem?'border-[var(--accent)]':''}`}><div className="p-4"><div className="flex gap-3 mb-2"><img src={p.authorAvatar} className="w-8 h-8 rounded-full"/><div><div className="font-bold text-sm flex items-center gap-1">{p.authorName} {p.isSystem && <span className="bg-[var(--accent)] text-white text-[10px] px-1 rounded">OFFICIAL</span>}</div><div className="text-[10px] opacity-60">{formatTime(p.createdAt)}</div></div></div><p className="text-sm opacity-90">{p.content}</p></div></Glass>)}
                </div>
            );
        };

        const App = () => {
            const [u, setU] = useState(null), [all, setAll] = useState({}), [v, setV] = useState('feed'), [sett, setSett] = useState(false);
            useEffect(()=>onAuthStateChanged(auth,x=>{if(x)onSnapshot(doc(db,'artifacts',_appId,'public','data','users',x.uid),d=>{if(d.exists())setU({...d.data(),isVerified:x.emailVerified}); else setDoc(doc(db,'artifacts',_appId,'public','data','users',x.uid),{uid:x.uid,email:x.email,displayName:x.displayName||"User",friendCode:generateCode(),avatarUrl:getAvatar(x.uid),friends:[],blocked:[],theme:'dark',isAdmin:false})}); else setU(null)}),[]);
            useEffect(()=>onSnapshot(collection(db,'artifacts',_appId,'public','data','users'),s=>{const m={};s.forEach(d=>m[d.id]={uid:d.id,...d.data()});setAll(m)}),[]);

            if(!u) return <AuthScreen/>;
            if(u.banned) return <div className="h-screen flex flex-col items-center justify-center bg-black text-red-600"><Skull size={64} className="animate-pulse mb-4"/><h1 className="text-4xl font-black">BANNED</h1></div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    <ThemeInjector theme={u.theme} c={u.customColors}/>
                    <nav className="w-16 bg-[var(--bg-secondary)] border-r border-[var(--border)] flex flex-col items-center py-4 gap-4 z-20">
                        <div className="w-10 h-10 bg-gradient-to-tr from-[var(--accent)] to-purple-400 rounded-lg flex items-center justify-center shadow-lg"><Zap className="text-white" size={20}/></div>
                        {['feed','friends','crews'].map(t=><button key={t} onClick={()=>setV(t)} className={`p-2 rounded-lg transition ${v===t?'bg-[var(--accent)] text-white':'text-[var(--text-secondary)]'}`}>{t==='feed'?<Hash/>:t==='friends'?<Users/>:<Globe/>}</button>)}
                        {u.isAdmin && <button onClick={()=>setV('admin')} className={`p-2 rounded-lg transition ${v==='admin'?'bg-red-600 text-white':'text-red-500'}`}><Shield/></button>}
                        <div className="mt-auto flex flex-col gap-2"><button onClick={()=>setSett(true)}><Settings className="text-[var(--text-secondary)]"/></button><button onClick={()=>signOut(auth)}><LogOut className="text-[var(--text-secondary)] hover:text-red-400"/></button></div>
                    </nav>
                    <main className="flex-1 bg-[var(--bg-primary)] overflow-hidden relative">
                        {v==='feed'&&<Feed user={u} allUsers={all}/>}{v==='friends'&&<Friends user={u} allUsers={all}/>}{v==='crews'&&<Crews user={u} allUsers={all}/>}{v==='admin'&&u.isAdmin&&<AdminDash user={u} allUsers={all} onExit={()=>setV('feed')}/>}
                    </main>
                    {sett && <SettingsModal user={u} onClose={()=>setSett(false)}/>}
                </div>
            );
        };
        createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
